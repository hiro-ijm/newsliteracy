# -*- coding: utf-8 -*-
"""Githubç”¨æ•™è‚²ã‚µã‚¤ãƒˆjsonå®Ÿè£…ç‰ˆ.ipynb  ã®ã‚³ãƒ”ãƒ¼

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1xsmeK250EtCrQBjIEpeh0IqB8EAIgzuh

ãƒ–ãƒ­ãƒƒã‚¯ï¼‘
**ã€å¿…è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€‘**
"""

!pip install streamlit
import random
import json
import streamlit as st # ğŸ’¡ ipywidgetsã®ä»£ã‚ã‚Šã«Streamlitã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# import pandas as pd # ãƒ‡ãƒ¼ã‚¿ãŒã‚·ãƒ³ãƒ—ãƒ«ãªã‚‰ä¸è¦ã§ã™ãŒã€å¤§è¦æ¨¡ãªã‚‰æ®‹ã—ã¦ã‚‚OK

# --- çŠ¶æ…‹ç®¡ç†ã®åˆæœŸåŒ– ---
# ãƒšãƒ¼ã‚¸é·ç§»ã‚„ç¾åœ¨ã®ã‚¯ã‚¤ã‚ºã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã« Streamlitã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’åˆæœŸåŒ–
if 'page' not in st.session_state:
    st.session_state.page = 'selection' # selection / quiz / result
    st.session_state.current_q = 0
    st.session_state.score = 0
    st.session_state.quiz_data = [] # å®Ÿè¡Œä¸­ã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿
    st.session_state.feedback = None # å›ç­”å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æƒ…å ±

"""ãƒ–ãƒ­ãƒƒã‚¯ï¼’
**ã€ã‚¯ã‚¤ã‚ºå†…å®¹ã®å®šç¾©ã€‘**
"""

# ğŸ’¡ ä¿®æ­£: ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®å¤–éƒ¨JSONãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®š
QUIZ_FILE = 'jsonãƒ•ã‚¡ã‚¤ãƒ«.json'

# ã‚³ãƒ¼ã‚¹ã®é¸æŠè‚¢
COURSE_OPTIONS = [5, 10, 20]

# StreamlitãŒãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã€é«˜é€ŸåŒ–ã™ã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼
@st.cache_data
def load_quiz_data(file_path):
    """JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ãƒªã‚¹ãƒˆå½¢å¼ã§è¿”ã™é–¢æ•°"""
    try:
        # Colabã§ã¯ãªãã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆï¼ˆGitHubï¼‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
        with open(file_path, 'r', encoding='utf-8') as file:
            quiz_list = json.load(file)
            print(f"âœ… ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ {len(quiz_list)} ä»¶ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚")
            return quiz_list
    except FileNotFoundError:
        st.error(f"âŒ ã‚¨ãƒ©ãƒ¼: ã‚¯ã‚¤ã‚ºãƒ•ã‚¡ã‚¤ãƒ« '{file_path}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        return []
    except json.JSONDecodeError:
        st.error(f"âŒ ã‚¨ãƒ©ãƒ¼: ã‚¯ã‚¤ã‚ºãƒ•ã‚¡ã‚¤ãƒ« '{file_path}' ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚")
        return []

# å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€æ—¢å­˜ã®å¤‰æ•°ã«æ ¼ç´
quiz_data_all = load_quiz_data(QUIZ_FILE)

if not quiz_data_all:
     st.warning("âš ï¸ è­¦å‘Š: ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯å‹•ä½œã—ã¾ã™ãŒã‚¯ã‚¤ã‚ºã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚")

"""ãƒ–ãƒ­ãƒƒã‚¯ï¼“
**ã€å¤‰æ•°ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°ã€‘**
"""

# --- ã‚¯ã‚¤ã‚ºã®èµ·å‹•ã¨ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ ---

def start_quiz(num_questions):
    """é¸æŠã•ã‚ŒãŸã‚³ãƒ¼ã‚¹ã«åŸºã¥ã„ã¦ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹é–¢æ•°"""

    # ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã€é¸æŠã•ã‚ŒãŸæ•°ã ã‘å•é¡Œã‚’å–å¾—
    if num_questions > len(quiz_data_all):
        selected_questions = quiz_data_all[:]
    else:
        selected_questions = random.sample(quiz_data_all, num_questions)

    # çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã¦ã‚¯ã‚¤ã‚ºç”»é¢ã¸é·ç§»
    st.session_state.quiz_data = selected_questions
    st.session_state.total_questions = len(selected_questions)
    st.session_state.current_q = 0
    st.session_state.score = 0
    st.session_state.feedback = None
    st.session_state.page = 'quiz'


# --- å›ç­”ã®ãƒã‚§ãƒƒã‚¯ã¨çŠ¶æ…‹æ›´æ–° ---

def check_answer(selected_index):
    """å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¨­å®šã™ã‚‹é–¢æ•°"""
    q_data = st.session_state.quiz_data[st.session_state.current_q]
    is_correct = (selected_index == q_data['answer_index'])

    if is_correct:
        st.session_state.score += 1
        feedback_status = 'âœ… æ­£è§£ã§ã™ï¼'
    else:
        feedback_status = 'âŒ ä¸æ­£è§£ã§ã™ã€‚'

    # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’çŠ¶æ…‹ã«ä¿å­˜
    st.session_state.feedback = {
        'status': feedback_status,
        'rationale': q_data['rationale']
    }
    # æ¬¡ã®è³ªå•ã¸é€²ã‚€æº–å‚™
    st.session_state.current_q += 1


# --- ç”»é¢æç”»é–¢æ•° ---

def display_selection_page():
    """ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ã®æç”»ï¼ˆStreamlitã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹ç¯‰ï¼‰"""
    st.title('ğŸ’¡ ã‚³ãƒ¼ã‚¹é¸æŠ')
    st.write("ä½•å•ã§æƒ…å ±ãƒªãƒ†ãƒ©ã‚·ãƒ¼ãƒ»ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¾ã™ã‹ï¼Ÿ")

    # URLã‚’è¡¨ç¤º (Colabã§ã®è¡¨ç¤ºã¯ä¸è¦ã ãŒã€Streamlitã§æƒ…å ±ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹)
    st.info(f'ã“ã®ã‚¢ãƒ—ãƒªã¯ Streamlit Cloud ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚') # ğŸ’¡ ä¿®æ­£: å…¬é–‹ã‚µãƒ¼ãƒ“ã‚¹ã®URLã‚’æ¨å¥¨

    # ã‚³ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã§é…ç½®
    cols = st.columns(len(COURSE_OPTIONS))
    for col, num in zip(cols, COURSE_OPTIONS):
        if num > len(quiz_data_all):
             description = f'å…¨{len(quiz_data_all)}å•ã‚³ãƒ¼ã‚¹'
        else:
             description = f'{num}å•ã‚³ãƒ¼ã‚¹'

        # Streamlitã®ãƒœã‚¿ãƒ³ã€‚ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ start_quiz ã‚’å‘¼ã³å‡ºã—ã€ç”»é¢ã‚’å†å®Ÿè¡Œ
        if col.button(description, key=f"course_{num}"):
            start_quiz(num)
            st.rerun() # ç”»é¢å…¨ä½“ã‚’å†å®Ÿè¡Œã—ã¦ã‚¯ã‚¤ã‚ºç”»é¢ã¸é·ç§»

def display_quiz_page():
    """ã‚¯ã‚¤ã‚ºç”»é¢ã®æç”»ï¼ˆStreamlitã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹ç¯‰ï¼‰"""

    # ãƒšãƒ¼ã‚¸ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸç›´å¾Œã€ã¾ãŸã¯å…¨å•çµ‚äº†ã®å ´åˆã®å‡¦ç†
    if st.session_state.current_q >= st.session_state.total_questions:
        st.session_state.page = 'result'
        st.rerun() # çµæœç”»é¢ã¸å¼·åˆ¶é·ç§»
        return

    q_index = st.session_state.current_q # ç¾åœ¨è¡¨ç¤ºã™ã¹ãè³ªå•ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    q_data = st.session_state.quiz_data[q_index]

    st.subheader(f"Q{q_index + 1} / {st.session_state.total_questions}: {q_data['question']}")

    # --- é¸æŠè‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã¨å›ç­”å‡¦ç† ---
    # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ãªã„ã‚ˆã†ã«ã™ã‚‹
    disable_buttons = st.session_state.feedback is not None

    for i, option_text in enumerate(q_data['options']):
        # Streamlitã®ãƒœã‚¿ãƒ³: ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ãƒã‚§ãƒƒã‚¯é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€å†æç”»
        if st.button(f"[{i + 1}] {option_text}", key=f"q_{q_index}_opt_{i}", disabled=disable_buttons):
            check_answer(i)
            st.rerun() # ç”»é¢å…¨ä½“ã‚’å†å®Ÿè¡Œã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º

    # --- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ ---
    if st.session_state.feedback:
        fb = st.session_state.feedback

        # æ­£èª¤ã«å¿œã˜ãŸè¡¨ç¤º
        if fb['status'].startswith('âœ…'):
             st.success(fb['status'])
        else:
             st.error(fb['status'])

        # è§£èª¬ã®è¡¨ç¤º
        st.info(f"ã€è§£èª¬ã€‘ {fb['rationale']}")

        # æ¬¡ã®è³ªå•ã¸é€²ã‚€ãƒœã‚¿ãƒ³
        if st.button("æ¬¡ã®è³ªå•ã¸", key="next_q_button"):
            # feedbackã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ç”»é¢å…¨ä½“ã‚’å†å®Ÿè¡Œ (æ¬¡ã®è³ªå•ãŒè¡¨ç¤ºã•ã‚Œã‚‹)
            st.session_state.feedback = None
            st.rerun()

def display_result_page():
    """æœ€çµ‚çµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°"""
    st.balloons()
    st.title('âœ… å…¨å•çµ‚äº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼')
    st.markdown(
        f'<p style="font-size: 24px; color: darkorange;">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: **{st.session_state.score} / {st.session_state.total_questions}** ç‚¹</p>',
        unsafe_allow_html=True
    )
    st.write('AIæ™‚ä»£ã®æƒ…å ±ãƒªãƒ†ãƒ©ã‚·ãƒ¼å‘ä¸Šã«å‘ã‘ã¦ã€ä¸€ç·’ã«å­¦ã‚“ã§ã„ãã¾ã—ã‚‡ã†ï¼')

    # ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
    if st.button("ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹"):
        st.session_state.page = 'selection'
        st.rerun() # ç”»é¢å…¨ä½“ã‚’å†å®Ÿè¡Œã—ã¦ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ã¸

"""ãƒ–ãƒ­ãƒƒã‚¯ï¼”**ã€ã‚¯ã‚¤ã‚ºå®Ÿè¡Œã€‘**"""

# --- ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã«å¿œã˜ã¦æç”» ---
# Streamlitã¯ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’ä¸Šã‹ã‚‰é †ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒãƒšãƒ¼ã‚¸ã®åˆ‡ã‚Šæ›¿ãˆã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚

if st.session_state.page == 'selection':
    display_selection_page()
elif st.session_state.page == 'quiz':
    display_quiz_page() # ã‚¯ã‚¤ã‚ºã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
elif st.session_state.page == 'result':
    display_result_page()