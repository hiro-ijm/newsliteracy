# -*- coding: utf-8 -*-
"""æ•™è‚²ã‚µã‚¤ãƒˆjsonå®Ÿè£…ç‰ˆ.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1VEJyG8eQ5cEfEv9G6_4Uuwf3zug2hgHP

ãƒ–ãƒ­ãƒƒã‚¯ï¼‘
**ã€å¿…è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€‘**
"""

import random
import ipywidgets as widgets
from IPython.display import display, clear_output
import json # ğŸ’¡ è¿½åŠ : JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰±ã†ãŸã‚ã«å¿…è¦

"""ãƒ–ãƒ­ãƒƒã‚¯ï¼’
**ã€ã‚¯ã‚¤ã‚ºå†…å®¹ã®å®šç¾©ã€‘**
"""

"""ãƒ–ãƒ­ãƒƒã‚¯ï¼’
**ã€ã‚¯ã‚¤ã‚ºå†…å®¹ã®å®šç¾©ã€‘**
"""

import json # ğŸ’¡ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰±ã†ãŸã‚ã«å¿…è¦ (ãƒ–ãƒ­ãƒƒã‚¯1ã«ç§»å‹•ã—ã¦ã‚‚å¯)

# ğŸ’¡ ä¿®æ­£: ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®å¤–éƒ¨JSONãƒ•ã‚¡ã‚¤ãƒ«åã‚’ 'quiz_800.json' ã«å¤‰æ›´
QUIZ_FILE = 'jsonãƒ•ã‚¡ã‚¤ãƒ«.json'

def load_quiz_data(file_path):
    """JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ãƒªã‚¹ãƒˆå½¢å¼ã§è¿”ã™é–¢æ•°"""
    try:
        # Colabã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã€JSONã¨ã—ã¦èª­ã¿è¾¼ã‚€
        with open(file_path, 'r', encoding='utf-8') as file:
            quiz_list = json.load(file)
            print(f"âœ… ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ {len(quiz_list)} ä»¶ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚")
            return quiz_list
    except FileNotFoundError:
        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: ã‚¯ã‚¤ã‚ºãƒ•ã‚¡ã‚¤ãƒ« '{file_path}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        print("    Google Colabã®å·¦å´ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒãƒ«ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        return []
    except json.JSONDecodeError:
        # JSONå½¢å¼ãŒä¸æ­£ãªå ´åˆã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: ã‚¯ã‚¤ã‚ºãƒ•ã‚¡ã‚¤ãƒ« '{file_path}' ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚JSONã®å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        return []

# å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€æ—¢å­˜ã®å¤‰æ•°ã«æ ¼ç´
# å…ƒã€…ã‚ã£ãŸå·¨å¤§ãª quiz_data_all ãƒªã‚¹ãƒˆã®å®šç¾©ãŒã“ã®ä¸€è¡Œã«ç½®ãæ›ã‚ã‚Šã¾ã™
quiz_data_all = load_quiz_data(QUIZ_FILE)

if not quiz_data_all:
     print("âš ï¸ è­¦å‘Š: ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯å‹•ä½œã—ã¾ã™ãŒã‚¯ã‚¤ã‚ºã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚")

"""ãƒ–ãƒ­ãƒƒã‚¯ï¼“
**ã€å¤‰æ•°ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°ã€‘**
"""

"""ãƒ–ãƒ­ãƒƒã‚¯ï¼“
**ã€å¤‰æ•°ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°ã€‘**
"""

# --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨åˆæœŸè¨­å®š ---
# å®Ÿè¡Œã™ã‚‹ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ (é¸æŠã•ã‚ŒãŸã‚³ãƒ¼ã‚¹ã«ã‚ˆã£ã¦å†…å®¹ãŒå¤‰ã‚ã‚‹)
quiz_data = []
current_question_index = 0
score = 0
total_questions = 0

# ã€å¤‰æ›´ã€‘ã“ã®Colabãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®URLã‚’ä¸€èˆ¬çš„ãªã‚µã‚¤ãƒˆURLã«ä¿®æ­£
COLAB_URL = "https://example.com/your-quiz-site" # ğŸ’¡ ä¿®æ­£: ã“ã“ã‚’å®Ÿéš›ã®ã‚µã‚¤ãƒˆURLã«ç½®ãæ›ãˆã¦ãã ã•ã„

# çµæœã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®Outputã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
output = widgets.Output()
course_options = [5, 10, 20]


# --- ã‚¯ã‚¤ã‚ºã®èµ·å‹•ã¨ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ ---

def start_quiz(num_questions):
    """é¸æŠã•ã‚ŒãŸã‚³ãƒ¼ã‚¹ã«åŸºã¥ã„ã¦ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹é–¢æ•°"""
    global quiz_data, total_questions, current_question_index, score

    # ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã€é¸æŠã•ã‚ŒãŸæ•°ã ã‘å•é¡Œã‚’å–å¾—
    if num_questions > len(quiz_data_all):
        selected_questions = quiz_data_all[:]
    else:
        selected_questions = random.sample(quiz_data_all, num_questions)

    quiz_data = selected_questions
    total_questions = len(quiz_data)
    current_question_index = 0
    score = 0

    display_question()


def display_course_selection():
    """ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°"""
    title_html = widgets.HTML("<h1>ã‚³ãƒ¼ã‚¹é¸æŠ</h1>")
    subtitle_html = widgets.HTML("<p>ä½•å•ã§æƒ…å ±ãƒªãƒ†ãƒ©ã‚·ãƒ¼ãƒ»ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¾ã™ã‹ï¼Ÿ</p>")

    # URLã‚’è¡¨ç¤º (å¤‰æ•°ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ãŒã€è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰ã‚ã‚‰ãªã„)
    url_html = widgets.HTML(f'<p>ğŸ‘‰ ã“ã®ã‚¯ã‚¤ã‚ºã‚µã‚¤ãƒˆã®URL: <a href="{COLAB_URL}" target="_blank">{COLAB_URL}</a></p>')

    buttons = []
    for num in course_options:
        if num > len(quiz_data_all):
             description = f'å…¨{len(quiz_data_all)}å•ã‚³ãƒ¼ã‚¹'
        else:
             description = f'ğŸ§  {num}å•ã‚³ãƒ¼ã‚¹'

        button = widgets.Button(description=description, button_style='primary')
        # ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ start_quiz ã‚’å‘¼ã³å‡ºã™
        button.on_click(lambda b, n=num: start_quiz(n))
        button.style.button_color = '#00796B'
        buttons.append(button)

    course_box = widgets.VBox(buttons) # ç¸¦ã«ä¸¦ã¹ã‚‹VBoxã‚’ä½¿ç”¨

    with output:
        clear_output(wait=True)
        # URLã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’è¿½åŠ 
        display(title_html, subtitle_html, url_html, course_box)


# --- ã‚¯ã‚¤ã‚ºã®è¡¨ç¤ºã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•° ---

def display_question():
    """ç¾åœ¨ã®è³ªå•ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°"""
    global current_question_index

    if current_question_index >= total_questions:
        display_results()
        return

    q_data = quiz_data[current_question_index]

    question_html = widgets.HTML(f"<h2>Q{current_question_index + 1} / {total_questions}: {q_data['question']}</h2>")

    # --- é¸æŠè‚¢ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ ---
    options_with_index = []
    original_answer_index = q_data['answer_index']

    # (é¸æŠè‚¢ãƒ†ã‚­ã‚¹ãƒˆ, å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹) ã®ã‚¿ãƒ—ãƒ«ã‚’ä½œæˆ
    for i, option_text in enumerate(q_data['options']):
        options_with_index.append((option_text, i))

    # ğŸ’¡ é¸æŠè‚¢ã®ãƒªã‚¹ãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    random.shuffle(options_with_index)

    # ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¾Œã®ãƒªã‚¹ãƒˆã‹ã‚‰æ–°ã—ã„æ­£è§£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¢ã™
    shuffled_options = [item[0] for item in options_with_index]
    shuffled_answer_index = -1 # åˆæœŸåŒ–

    for i, (_, original_index) in enumerate(options_with_index):
        if original_index == original_answer_index:
            shuffled_answer_index = i
            break

    # --- é¸æŠè‚¢ã®è¡¨ç¤ºã¨ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆ ---
    option_widgets = []
    # ğŸ’¡ ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸé¸æŠè‚¢ã®ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
    for i, option_text in enumerate(shuffled_options):

        # 1. é¸æŠè‚¢ãƒ†ã‚­ã‚¹ãƒˆï¼ˆHTMLã‚’ä½¿ç”¨ã—ã€ç¢ºå®Ÿã«æŠ˜ã‚Šè¿”ã™ï¼‰
        option_label_html = widgets.HTML(
            # white-space: normal; ã§æŠ˜ã‚Šè¿”ã—ã‚’å¼·åˆ¶
            value=f'<div style="font-size: 16px; font-weight: bold; padding: 10px; white-space: normal;">'
                  f'[{i + 1}] {option_text}'
                  f'</div>',
            layout=widgets.Layout(width='100%')
        )

        # 2. ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‹…ã†ãƒœã‚¿ãƒ³
        click_button = widgets.Button(
            description="é¸æŠã™ã‚‹",
            button_style='info',
            layout=widgets.Layout(width='100%', height='auto', min_height='35px'),
            style=widgets.ButtonStyle(button_color='#00796B', text_color='white')
        )

        # ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š: é¸æŠã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (i) ã¨ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¾Œã®æ­£è§£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¸¡ã™
        click_button.on_click(lambda b, index=i, answer=shuffled_answer_index, data=q_data: check_answer(index, answer, data))

        # 3. ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒœã‚¿ãƒ³ã‚’ã‚»ãƒƒãƒˆã«ã—ãŸVBoxã‚’ä¸€ã¤ã®é¸æŠè‚¢ã¨ã™ã‚‹
        option_container = widgets.VBox([
            option_label_html,
            click_button
        ], layout=widgets.Layout(border='2px solid #00796B', margin='10px 0', padding='0'))

        option_widgets.append(option_container)

    # ğŸ’¡ è³ªå•ç”»é¢ã‹ã‚‰ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’ã€é¸æŠè‚¢ã¨åŒã˜å½¢çŠ¶ã§è¿½åŠ 
    back_to_course_label = widgets.HTML(
        value=f'<div style="font-size: 16px; font-weight: bold; padding: 10px; white-space: normal; color: #B71C1C;">'
              f'â†© ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹'
              f'</div>',
        layout=widgets.Layout(width='100%')
    )
    back_to_course_button = widgets.Button(
        description="ã“ã®ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­ã™ã‚‹",
        button_style='danger',
        layout=widgets.Layout(width='100%', height='auto', min_height='35px'),
        style=widgets.ButtonStyle(button_color='#B71C1C', text_color='white')
    )
    back_to_course_button.on_click(lambda b: display_course_selection())
    back_to_course_container = widgets.VBox([
        back_to_course_label,
        back_to_course_button
    ], layout=widgets.Layout(border='2px solid #B71C1C', margin='10px 0', padding='0'))
    option_widgets.append(back_to_course_container)

    options_vbox = widgets.VBox(option_widgets)

    # è³ªå•ã®å…¨è¦ç´ ã‚’VBoxã‚³ãƒ³ãƒ†ãƒŠã§åŒ…ã‚“ã§è¡¨ç¤º
    quiz_elements = widgets.VBox([question_html, options_vbox])

    with output:
        clear_output(wait=True)
        display(quiz_elements)


def check_answer(selected_index, shuffled_answer_index, q_data):
    """å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€çµæœã¨è§£èª¬ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°"""
    global current_question_index, score

    # ğŸ’¡ ä¿®æ­£: ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¾Œã®æ­£è§£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨æ¯”è¼ƒ
    is_correct = (selected_index == shuffled_answer_index)

    feedback_html = widgets.HTML()
    next_button = widgets.Button(description="â–¶ æ¬¡ã®è³ªå•ã¸", button_style='success')

    # ğŸ’¡ è¿½åŠ : è§£èª¬ç”»é¢ã‹ã‚‰ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
    back_to_course_button_feedback = widgets.Button(
        description="ğŸ  ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ã«æˆ»ã‚‹ (ä¸­æ–­)",
        button_style='danger',
        layout=widgets.Layout(width='auto', min_height='35px')
    )
    back_to_course_button_feedback.on_click(lambda b: display_course_selection())

    if is_correct:
        feedback_html.value = '<h3 style="color: green;">âœ… æ­£è§£ã§ã™ï¼</h3>'
        score += 1
    else:
        # ğŸ’¡ ä¿®æ­£: ä¸æ­£è§£ã®å ´åˆã€æ­£è§£ã®é¸æŠè‚¢ã‚’è¡¨ç¤ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
        original_answer_text = q_data['options'][q_data['answer_index']]
        feedback_html.value = (
            '<h3 style="color: red;">âŒ ä¸æ­£è§£ã§ã™ã€‚</h3>'
            f'<p style="font-size: 18px; color: green; font-weight: bold;">'
            f'æ­£è§£: {original_answer_text}'
            f'</p>'
        )

    rationale_html = widgets.HTML(
        f'<p style="border: 2px solid #4CAF50; padding: 15px; background-color: #E8F5E9; border-radius: 5px; color: #006400;">'
        f'<strong>ã€è§£èª¬ã€‘</strong> {q_data["rationale"]}'
        f'</p>'
    )

    next_button.on_click(lambda b: next_question())

    # ãƒœã‚¿ãƒ³ã‚’æ¨ªã«ä¸¦ã¹ã‚‹HBox
    action_buttons = widgets.HBox([next_button, back_to_course_button_feedback])

    # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®å…¨è¦ç´ ã‚’VBoxã‚³ãƒ³ãƒ†ãƒŠã§ã¾ã¨ã‚ã¦æç”»å®‰å®šæ€§ã‚’é«˜ã‚ã‚‹
    feedback_elements = widgets.VBox([feedback_html, rationale_html, action_buttons])

    with output:
        clear_output(wait=True)
        display(feedback_elements)


def next_question():
    """è³ªå•ç•ªå·ã‚’å¢—ã‚„ã—ã¦æ¬¡ã®è³ªå•ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°"""
    global current_question_index
    current_question_index += 1
    display_question()


def display_results():
    """æœ€çµ‚çµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°"""
    result_html = widgets.HTML(
        f'<h1 style="color: navy;">å…¨å•çµ‚äº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h1>'
        f'<p style="font-size: 20px;">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: <strong style="color: darkorange;">{score} / {total_questions}</strong> ç‚¹</p>'
    )

    # ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
    restart_button = widgets.Button(description="ğŸ  ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ã«æˆ»ã‚‹", button_style='primary')
    restart_button.on_click(lambda b: display_course_selection())

    with output:
        clear_output(wait=True)
        display(result_html, restart_button)

"""ãƒ–ãƒ­ãƒƒã‚¯ï¼”**ã€ã‚¯ã‚¤ã‚ºå®Ÿè¡Œã€‘**"""

# Colabã®ã‚»ãƒ«ã«å‡ºåŠ›ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’è¡¨ç¤ºã—ã€åˆæœŸç”»é¢ã‚’å‘¼ã³å‡ºã™
display(output)
display_course_selection()
